<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra C·ª©u D·ªØ Li·ªáu B√°n H√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.33/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f2f5;
        }
        .container-fluid {
            padding-top: 20px;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background-color: #ffffff;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-radius: 12px 12px 0 0;
            padding: 1rem;
        }
        .btn {
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .form-control, .form-select {
            border-radius: 8px;
        }
        .chart-container {
            height: 300px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        #data-table th {
            background-color: #f8f9fa;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card">
                <div class="card-header text-center">
                    <h2>üìä Tra C·ª©u D·ªØ Li·ªáu B√°n H√†ng</h2>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end mb-4">
                        <div class="col-md-3 col-lg-2">
                            <label for="fromDate" class="form-label">T·ª´ ng√†y:</label>
                            <input type="text" id="fromDate" class="form-control" placeholder="dd-mm-yyyy">
                        </div>
                        <div class="col-md-3 col-lg-2">
                            <label for="toDate" class="form-label">ƒê·∫øn ng√†y:</label>
                            <input type="text" id="toDate" class="form-control" placeholder="dd-mm-yyyy">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label for="productSelect" class="form-label">S·∫£n ph·∫©m:</label>
                            <select id="productSelect" class="form-select">
                                <option value="">T·∫•t c·∫£</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label for="staffSelect" class="form-label">Nh√¢n vi√™n:</label>
                            <select id="staffSelect" class="form-select">
                                <option value="">T·∫•t c·∫£</option>
                            </select>
                        </div>
                        <div class="col-12 col-lg-2 text-md-end d-flex gap-2">
                            <button class="btn btn-primary flex-grow-1" onclick="applyFilters()">L·ªçc</button>
                            <button class="btn btn-secondary flex-grow-1" onclick="resetFilters()">B·ªè l·ªçc</button>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12 text-end">
                            <button class="btn btn-secondary me-2" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
                            <button class="btn btn-secondary" onclick="exportToPDF()">üìÑ Xu·∫•t PDF</button>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-lg-6">
                            <div class="card p-3 mb-4">
                                <h5 class="card-title text-center">Doanh Thu Theo S·∫£n Ph·∫©m</h5>
                                <div class="chart-container">
                                    <canvas id="productChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card p-3 mb-4">
                                <h5 class="card-title text-center">Doanh Thu Theo Nh√¢n Vi√™n</h5>
                                <div class="chart-container">
                                    <canvas id="staffChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div id="loading" class="text-center my-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i d·ªØ li·ªáu...</span>
                        </div>
                        <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </div>

                    <div class="table-responsive">
                        <table id="data-table" class="table table-striped table-hover" style="display: none;">
                            <thead class="table-light">
                                <tr id="header-row"></tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const url = "https://script.google.com/macros/s/AKfycbxqWVBEtubmt3qe20hs6swV79oSFU63pM12oT-Gd9VcFxODOlAqPEEfUQslZswqdHIj/exec";
    let rawData = [];
    let productChart, staffChart;
    let fromDateInstance, toDateInstance;

    // Kh·ªüi t·∫°o Flatpickr
    fromDateInstance = flatpickr("#fromDate", { dateFormat: "d-m-Y" });
    toDateInstance = flatpickr("#toDate", { dateFormat: "d-m-Y" });

    // Fetch d·ªØ li·ªáu v√† kh·ªüi t·∫°o
    fetch(url)
        .then(res => res.json())
        .then(data => {
            rawData = data;
            
            // Format ng√†y t·ª´ yyyy-mm-ddT... sang dd-mm-yyyy v√† b·ªè gi·ªù
            rawData.forEach(row => {
                const date = row["Ng√†y b√°n"];
                if (date) {
                    const datePart = date.split('T')[0];
                    const dateParts = datePart.split('-');
                    row["Ng√†y b√°n"] = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                }
            });

            // Populate c√°c dropdown
            populateDropdowns(rawData);
            
            // X√¢y d·ª±ng b·∫£ng v√† bi·ªÉu ƒë·ªì l·∫ßn ƒë·∫ßu
            buildTable(rawData);
            createCharts(rawData);
            document.getElementById("loading").style.display = "none";
            document.getElementById("data-table").style.display = "table";
        })
        .catch(error => {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", error);
            document.getElementById("loading").innerHTML = '<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
        });

    function populateDropdowns(data) {
        const products = [...new Set(data.map(item => item["T√™n s·∫£n ph·∫©m"]))].filter(Boolean);
        const staff = [...new Set(data.map(item => item["Nh√¢n vi√™n b√°n"]))].filter(Boolean);

        const productSelect = document.getElementById("productSelect");
        products.forEach(p => {
            const option = document.createElement("option");
            option.value = p;
            option.textContent = p;
            productSelect.appendChild(option);
        });

        const staffSelect = document.getElementById("staffSelect");
        staff.forEach(s => {
            const option = document.createElement("option");
            option.value = s;
            option.textContent = s;
            staffSelect.appendChild(option);
        });
    }

    function buildTable(data) {
        const tableBody = document.getElementById("table-body");
        tableBody.innerHTML = "";
        
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</td></tr>';
            return;
        }

        const headers = Object.keys(data[0]);
        const headerRow = document.getElementById("header-row");
        headerRow.innerHTML = "";
        headers.forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            headerRow.appendChild(th);
        });

        data.forEach(row => {
            const tr = document.createElement("tr");
            headers.forEach(h => {
                const td = document.createElement("td");
                td.textContent = row[h];
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    function createCharts(data) {
        const productSales = {};
        const staffSales = {};
        data.forEach(row => {
            const price = parseFloat(row["Gi√°"]);
            const quantity = parseInt(row["S·ªë l∆∞·ª£ng"]);
            const product = row["T√™n s·∫£n ph·∫©m"];
            const staff = row["Nh√¢n vi√™n b√°n"];
            const total = (price && quantity) ? price * quantity : 0;
            
            if (product) productSales[product] = (productSales[product] || 0) + total;
            if (staff) staffSales[staff] = (staffSales[staff] || 0) + total;
        });

        if (productChart) productChart.destroy();
        const ctxProduct = document.getElementById('productChart').getContext('2d');
        productChart = new Chart(ctxProduct, {
            type: 'bar',
            data: {
                labels: Object.keys(productSales),
                datasets: [{
                    label: 'Doanh thu (VND)',
                    data: Object.values(productSales),
                    backgroundColor: 'rgba(0, 123, 255, 0.6)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        if (staffChart) staffChart.destroy();
        const ctxStaff = document.getElementById('staffChart').getContext('2d');
        staffChart = new Chart(ctxStaff, {
            type: 'doughnut',
            data: {
                labels: Object.keys(staffSales),
                datasets: [{
                    label: 'Doanh thu (VND)',
                    data: Object.values(staffSales),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 159, 64, 0.6)'
                    ]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function applyFilters() {
        const fromDateStr = document.getElementById("fromDate").value;
        const toDateStr = document.getElementById("toDate").value;
        const productSearch = document.getElementById("productSelect").value;
        const staffSearch = document.getElementById("staffSelect").value;

        const filtered = rawData.filter(row => {
            const dateStr = row["Ng√†y b√°n"];
            const dateParts = dateStr.split('-');
            const rowDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);

            const fromDate = fromDateStr ? new Date(fromDateStr.split('-')[2], fromDateStr.split('-')[1] - 1, fromDateStr.split('-')[0]) : null;
            const toDate = toDateStr ? new Date(toDateStr.split('-')[2], toDateStr.split('-')[1] - 1, toDateStr.split('-')[0]) : null;

            const inDateRange = (!fromDate || rowDate >= fromDate) && (!toDate || rowDate <= toDate);
            const matchProduct = !productSearch || row["T√™n s·∫£n ph·∫©m"] === productSearch;
            const matchStaff = !staffSearch || row["Nh√¢n vi√™n b√°n"] === staffSearch;

            return inDateRange && matchProduct && matchStaff;
        });

        buildTable(filtered);
        createCharts(filtered);
    }
    
    function resetFilters() {
        fromDateInstance.clear();
        toDateInstance.clear();
        document.getElementById("productSelect").value = "";
        document.getElementById("staffSelect").value = "";
        applyFilters();
    }

    function exportToExcel() {
        const table = document.getElementById("data-table");
        const wb = XLSX.utils.table_to_book(table, { sheet: "D·ªØ li·ªáu b√°n h√†ng" });
        XLSX.writeFile(wb, "du_lieu_ban_hang.xlsx");
    }

    async function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("B√°o c√°o d·ªØ li·ªáu b√°n h√†ng", 14, 14);
        const table = document.getElementById("data-table");
        doc.autoTable({ html: table, startY: 20 });
        doc.save("du_lieu_ban_hang.pdf");
    }
</script>

</body>
</html>
