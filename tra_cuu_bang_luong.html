<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Lương Nhân Viên</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 2.5rem; /* Equivalent to 30px */
            border-radius: 0.5rem; /* Equivalent to 8px */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 20px auto; /* Add margin-top and margin-bottom */
        }
        h1 {
            color: #333;
            margin-bottom: 1.5rem; /* Equivalent to 30px */
        }
        table {
            border-collapse: collapse;
            margin-bottom: 1.25rem; /* Equivalent to 20px */
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 0.75rem; /* Equivalent to 12px */
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            color: #333;
        }
        td.total {
            font-weight: bold;
            background-color: #e6f7ff;
        }
        .note {
            margin-top: 1.25rem; /* Equivalent to 20px */
            padding: 0.625rem; /* Equivalent to 10px */
            background-color: #fffacd;
            border-left: 5px solid #ffebcd;
        }
        .info-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.25rem; /* Equivalent to 20px */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .info-item {
            flex: 1;
            padding: 0 0.625rem; /* Equivalent to 0 10px */
            min-width: 280px; /* Ensure items don't get too small */
        }
        .info-item strong {
            display: block;
            margin-bottom: 0.3125rem; /* Equivalent to 5px */
            color: #555;
        }
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .info-header {
                flex-direction: column;
            }
            .info-item {
                padding: 0.5rem 0;
            }
        }
    </style>
</head>
<body class="p-5">
    <div class="container rounded-lg shadow-md">
        <h1 class="text-3xl font-bold text-center mb-6">PHIẾU LƯƠNG THÁNG <span id="month">XX</span> NĂM <span id="year">YYYY</span></h1>

        <div class="info-header">
            <div class="info-item">
                <strong>Mã NV:</strong> <span id="employee-id"></span>
            </div>
            <div class="info-item">
                <strong>Họ và tên:</strong> <span id="full-name"></span>
            </div>
        </div>

        <div class="info-header">
            <div class="info-item">
                <strong>Phòng ban:</strong> <span id="department"></span>
            </div>
            <div class="info-item">
                <strong>Chức vụ:</strong> <span id="position"></span>
            </div>
        </div>

        <table class="w-full border border-gray-300 rounded-md overflow-hidden">
            <thead>
                <tr class="bg-gray-100 text-gray-700">
                    <th class="py-3 px-4 border-b border-gray-300">STT</th>
                    <th class="py-3 px-4 border-b border-gray-300">Khoản mục</th>
                    <th class="py-3 px-4 border-b border-gray-300 text-right">Số tiền (VNĐ)</th>
                </tr>
            </thead>
            <tbody id="salary-items-body">
                </tbody>
            <tfoot>
                <tr class="bg-blue-100 font-bold text-blue-800">
                    <td colspan="2" class="py-3 px-4 border-t border-gray-300 text-left">LƯƠNG THỰC LÃNH</td>
                    <td class="py-3 px-4 border-t border-gray-300 text-right" id="net-salary"></td>
                </tr>
            </tfoot>
        </table>

        <div class="info-header">
            <div class="info-item">
                <strong>Ngày công:</strong> <span id="work-days"></span>
            </div>
            <div class="info-item">
                </div>
        </div>

        <div class="note rounded-md">
            <strong>Ghi chú:</strong> <span id="notes"></span>
        </div>

        <div id="loading-message" class="text-center text-gray-600 mt-4 hidden">Đang tải dữ liệu...</div>
        <div id="error-message" class="text-center text-red-600 mt-4 hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const salaryItemsBody = document.getElementById('salary-items-body');

            // Function to get query parameters from URL
            function getQueryParams() {
                const params = {};
                window.location.search.substring(1).split('&').forEach(param => {
                    const parts = param.split('=');
                    if (parts.length === 2) {
                        params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
                    }
                });
                return params;
            }

            // Function to format numbers as Vietnamese currency (VND)
            function formatCurrency(amount) {
                if (typeof amount !== 'number') {
                    amount = parseFloat(amount);
                    if (isNaN(amount)) {
                        return '';
                    }
                }
                return amount.toLocaleString('vi-VN') + ' VNĐ';
            }

            // Function to populate salary slip data
            async function fetchSalaryData() {
                const params = getQueryParams();
                const mnv = params.mnv;
                const nam = params.nam;
                const thang = params.thang;

                // --- QUAN TRỌNG: Thay thế URL này bằng URL Web App Google Apps Script thực tế của bạn ---
                // Google Apps Script Web App của bạn cần được triển khai và trả về JSON theo cấu trúc mong đợi.
                const jsonApiUrl = `https://script.google.com/macros/s/YOUR_DEPLOYED_WEB_APP_ID/exec?mnv=${mnv}&nam=${nam}&thang=${thang}`;
                // Ví dụ URL: https://script.google.com/macros/s/AKfycbz_YOUR_ID_HERE/exec?mnv=NV001&nam=2025&thang=06

                if (!mnv || !nam || !thang) {
                    errorMessage.textContent = 'Vui lòng cung cấp Mã NV, Năm và Tháng trên URL (ví dụ: ?mnv=NV001&nam=2025&thang=06)';
                    errorMessage.classList.remove('hidden');
                    return;
                }

                loadingMessage.classList.remove('hidden'); // Hiển thị thông báo đang tải
                errorMessage.classList.add('hidden'); // Ẩn bất kỳ lỗi trước đó
                salaryItemsBody.innerHTML = ''; // Xóa dữ liệu bảng cũ

                let data = null;
                try {
                    const response = await fetch(jsonApiUrl);
                    if (!response.ok) {
                        throw new Error(`Lỗi HTTP! status: ${response.status}. Có thể Web App URL không đúng hoặc không trả về dữ liệu.`);
                    }
                    data = await response.json();

                    // Kiểm tra nếu data rỗng, không có dữ liệu hoặc có trường 'error'
                    if (!data || Object.keys(data).length === 0 || data.error) {
                        const errorMsg = data && data.error ? data.error : 'Không tìm thấy dữ liệu cho Mã NV, Năm và Tháng này.';
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu lương:', error);
                    errorMessage.textContent = `Lỗi: ${error.message}. Vui lòng kiểm tra lại Mã NV, Năm, Tháng hoặc URL API.`;
                    errorMessage.classList.remove('hidden');
                    loadingMessage.classList.add('hidden');
                    return;
                } finally {
                    loadingMessage.classList.add('hidden'); // Ẩn thông báo đang tải
                }

                // Điền thông tin tiêu đề
                document.getElementById('month').textContent = data.thang || 'XX';
                document.getElementById('year').textContent = data.nam || 'YYYY';
                document.getElementById('employee-id').textContent = data.mnv || '';
                document.getElementById('full-name').textContent = data.hoTen || '';
                document.getElementById('department').textContent = data.phongBan || '';
                document.getElementById('position').textContent = data.chucVu || '';

                // Điền các khoản mục lương động
                const salaryItems = [
                    { label: 'Lương cơ bản', value: data.luongCoBan },
                    { label: 'Phụ cấp', value: data.phuCap },
                    { label: 'Thưởng', value: data.thuong },
                    { label: 'Phạt', value: data.phat },
                    // Thêm các khoản mục khác nếu có trong dữ liệu của bạn
                ];

                salaryItems.forEach((item, index) => {
                    const row = salaryItemsBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.label}</td>
                        <td class="text-right">${formatCurrency(item.value)}</td>
                    `;
                });

                // Điền lương thực lãnh và các chi tiết khác
                document.getElementById('net-salary').textContent = formatCurrency(data.luongThucLanh);
                document.getElementById('work-days').textContent = data.ngayCong || 'N/A'; // Hiển thị 'N/A' nếu không có dữ liệu
                document.getElementById('notes').textContent = data.ghiChu || 'Phiếu lương này chỉ có giá trị nội bộ.';
            }

            fetchSalaryData(); // Gọi hàm để tải dữ liệu khi trang tải
        });
    </script>
</body>
</html>
